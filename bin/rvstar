#!/usr/bin/env python
# encoding: utf-8
#
# @Author: Jon Holtzman, David Nidever
# @Date: March 2018, Sep 2020
# @Filename: apred
# @License: BSD 3-Clause
# @Copyright: Jon Holtzman

# Run Doppler RV and visit combination for a single star

from __future__ import division
from __future__ import print_function
from __future__ import absolute_import
from __future__ import unicode_literals

import argparse
import os
import sys
import subprocess
import pdb
import time
import datetime
import glob
from holtztools import struct
import numpy as np
from astropy.table import Table,Column

from apogee_drp.apred import rv
from apogee_drp.utils import bitmask,apload

if __name__ == '__main__' :

    parser = argparse.ArgumentParser(
        prog=os.path.basename(sys.argv[0]),
        description='Runs RVs')

    parser.add_argument('star', type=str, nargs=1,  help='Star Name')
    parser.add_argument('apred', type=str, nargs=1, help='APOGEE reduction version')
    parser.add_argument('instrument', type=str, nargs=1, help='APOGEE instrument')
    parser.add_argument('field', type=str, nargs=1, help='Field name')
    parser.add_argument("--nres",type=float,nargs=3,help='list of sinc widths',default=[5,4.25,3.5])
    parser.add_argument("--windows",type=float,nargs=1,help='Spectral windows')
    parser.add_argument('--tweak', action='store_true', help='do normalization tweak?')
    parser.add_argument("--done")
    parser.add_argument("--host")
    parser.add_argument("--flag",type=str,default='11111')
    parser.add_argument('-c','--clobber', action='store_true', help='Overwrite files?')
    parser.add_argument('-v','--verbose', action='store_true', help='Verbose output')
    parser.add_argument('-p','--plot', action='store_true', help='Make a plot')
    args = parser.parse_args()

    now = datetime.datetime.now()
    start = time.time()
    print("Start: ",now.strftime("%Y-%m-%d %H:%M:%S"))

    # Code copied from rv.dopple_rv()
    star = args.star[0]
    apred = args.apred[0]
    instrument = args.instrument[0]
    if instrument=='apogee-n':
        telescope = 'apo25m'
    if instrument=='apogee-s':
        telescope = 'lco25m'
    field = args.field[0]

    # Run doppler_rv_star() for this star
    rv.doppler_rv_star(star,apred,instrument,field,clobber=args.clobber,tweak=args.tweak,
                       nres=args.nres,windows=args.windows,verbose=args.verbose,plot=args.plot)


    now = datetime.datetime.now()
    print("End: ",now.strftime("%Y-%m-%d %H:%M:%S"))
    print("elapsed: ",time.time()-start)

    #if args.done is not None :
    #    subprocess.call(['setdone',args.done])
    #    try: 
    #        subprocess.call(['setdone',done])
    #    except: pass
    #    print('host', args.host)
    #    if args.host is not None :
    #        try: os.remove(args.done+'.'+args.host)
    #        except: pass
