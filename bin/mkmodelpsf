#!/usr/bin/env python
#
# Make APOGEE master PSF model calibration file

import traceback
from argparse import ArgumentParser
from apogee_drp.apred import psf

# Main command-line program
if __name__ == "__main__":
    parser = ArgumentParser(description='Make APOGEE master PSF calibration file')
    parser.add_argument('modelpsf', type=int, nargs=1, help='model PSF ID')
    parser.add_argument('sparseid', type=int, nargs=1, help='Sparse ID')
    parser.add_argument('psfid', type=int, nargs=1, help='PSF ID')
    parser.add_argument('apred', type=str, nargs=1, help='APOGEE Reduction version')
    parser.add_argument('telescoep', type=str, nargs=1, help='Telescope')
    parser.add_argument('--clobber', action='store_true', help='Overwrite any existing files')
    parser.add_argument('--verbose', action='store_true', help='Verbose output')
    args = parser.parse_args()

    modelpsf = args.modelpsf[0]
    sparseid = args.sparseid[0]
    psfid = args.psfid[0]
    apred = args.apred[0]
    telescope = args.telescope[0]
    chips = ['a','b','c']

    try:
        load = apload.ApLoad(apred=apred,telescope=telescope)
        sparsefile = load.filename('Sparse',num=sparseid,chips=True)
        psffile = load.filename('PSF',num=psfid,chips=True)
        for ch in chips:
            sparsefile1 = psffile.replace('Sparse-','Sparse-'+ch+'-')
            psffile1 = psffile.replace('PSF-','PSF-'+ch+'-')
            p = psf.makeprofilegrid(psffile1,sparsefile1,verbose=args.verbose)
            outfile = load.filename('PSFModel',num=modelpsf,chips=True).replace('PSFModel-','PSFModel-'+ch+'-')
            print('Writing to '+outfile)
            p.write(outfile)
    except:
        traceback.print_exc()
