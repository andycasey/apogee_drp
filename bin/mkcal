#!/usr/bin/env python
#
# Make APOGEE DRP master calibration products

import os
import time
import shutil
from glob import glob
from argparse import ArgumentParser
from dlnpyutils import utils as dln
import subprocess


# Main command-line program
if __name__ == "__main__":
    parser = ArgumentParser(description='Make APOGEE DRP master calibration products')
    parser.add_argument('vers', type=str, nargs=1, help='APOGEE Reduction version')
    parser.add_argument('--clobber', action='store_true', help='Overwrite any existing files')
    parser.add_argument('--links', type=str, nargs=1, help='Version to create cal symlinks to')
    args = parser.parse_args()

    if isinstance(args.vers,list):
        vers = args.vers[0]
    else:
        vers = args.vers

    apogee_redux = os.environ['APOGEE_REDUX']+'/'
    apogee_drp_dir = os.environ['APOGEE_DRP_DIR']+'/'

    print('Making APOGEE DRP master calibration products for version = ',vers)

    # Symbolic links
    if args.links is not None:
        linkvers = args.links[0]
        print('Creating calibration product symlinks to version >>',linkvers,'<<')
        cwd = os.path.abspath(os.curdir)
        for d in ['bpm','darkcorr','detector','flatcorr','fpi','littrow','lsf','persist','telluric','wave']:
            for obs in ['apogee-n','apogee-s']:    
                print('Creating symlinks for ',apogee_redux+vers+'/cal/'+obs+'/'+d)
                os.chdir(apogee_redux+vers+'/cal/'+obs+'/'+d)
                subprocess.run(['ln -s '+apogee_redux+linkvers+'/cal/'+obs+'/'+d+'/*fits .'],shell=True)

    print('All done')
