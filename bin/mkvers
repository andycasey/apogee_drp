#!/usr/bin/env python
#
# Setup APOGEE DRP version

import os
import time
from glob import glob
from argparse import ArgumentParser
from dlnpyutils import utils as dln
import subprocess


# Main command-line program
if __name__ == "__main__":
    parser = ArgumentParser(description='Setup APOGEE DRP directory structure')
    parser.add_argument('vers', type=str, nargs=1, help='APOGEE Reduction version')
    parser.add_argument('--fresh', action='store_true', help='Start fresh.')
    args = parser.parse_args()

    if isinstance(args.vers,list):
        vers = args.vers[0]
    else:
        vers = args.vers

    apogee_redux = os.environ['APOGEE_REDUX']+'/'
    apogee_drp_dir = os.environ['APOGEE_DRP_DIR']+'/'

    # Start fresh
    if args.fresh:
        files = glob(apogee_redux+vers)
    
    import pdb; pdb.set_trace()

    # Main directory
    if os.path.exists(apogee_redux+vers):
        os.makedirs(apogee_redux+vers)
    # First level
    for d in ['cal','exposures','stars','fields','visit','qa','plates','monitor','summary','log'] 
        if os.path.exists(apogee_redux+vers+'/'+d):
            os.makedirs(apogee_redux+vers+'/'+d)
    # North/south subdirectories
    for d in ['cal','exposures','monitor']:
        for obs in ['apogee-n','apogee-s']:
            if os.path.exists(apogee_redux+vers+'/'+d+'/'+obs):
                os.makedirs(apogee_redux+vers+'/'+d+'/'+obs)
    for d in ['visit','stars','fields']:
        for obs in ['apo25m','lco25m']:
            if os.path.exists(apogee_redux+vers+'/'+d+'/'+obs):
                os.makedirs(apogee_redux+vers+'/'+d+'/'+obs)
    for d in ['log']:
        for obs in ['apo','lco']:
            if os.path.exists(apogee_redux+vers+'/'+d+'/'+obs):
                os.makedirs(apogee_redux+vers+'/'+d+'/'+obs)
    # Cal subdirectories
    for d in ['bpm','darkcorr','detector','flatcorr','flux','fpi','html','littrow','lsf','persist','plans','psf','qa','telluric','trace','wave']:
        for obs in ['apogee-n','apogee-s']:
            if os.path.exists(apogee_redux+vers+'/cal/'+obs+'/'+d):
                os.makedirs(apogee_redux+vers+'/cal/'+obs+'/'+d)

    # Webpage files
    #if os.path.exists(apogee_drp_dir+'etc/htaccess'):
    #    os.copy(apogee_drp_dir+'etc/htaccess',apogee_redux+vers+'qa/.htaccess'
    if os.path.exists(apogee_drp_dir+'etc/sorttable.js'):
        os.copy(apogee_drp_dir+'etc/htaccess',apogee_redux+vers+'qa/sorttable.js'
